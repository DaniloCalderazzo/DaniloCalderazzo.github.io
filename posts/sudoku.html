<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sudoku Zen</title>
    <style>
        /* --- 1. ESTILOS GENERALES Y PALETA --- */
        :root {
            --primary: #9cb3c9;       /* Tu color base */
            --primary-dark: #78909c;  /* Un poco m√°s oscuro para contrastes */
            --bg-color: #f0f4f8;      /* Fondo muy suave */
            --board-bg: #ffffff;
            --text-color: #455a64;
            --accent-blue: #e1f5fe;   /* Para filas/columnas */
            --accent-select: #bbdefb; /* Selecci√≥n */
            --error-color: #ef9a9a;
            --success-color: #a5d6a7;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            overflow-y: auto; /* Scroll suave */
        }

        h1 {
            margin: 10px 0;
            font-weight: 300;
            color: var(--primary-dark);
            letter-spacing: 2px;
            text-transform: uppercase;
            font-size: 1.8rem;
        }

        /* --- 2. BARRA DE DIFICULTAD (P√≠ldoras) --- */
        #difficulty-controls {
            margin-bottom: 15px;
            display: flex;
            background: white;
            padding: 5px;
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .diff-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--primary-dark);
            font-weight: 600;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .diff-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        /* --- 3. BARRA DE ESTAD√çSTICAS (RACHA) --- */
        #stats-bar {
            display: flex;
            justify-content: space-between;
            width: 95vw;
            max-width: 400px;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .streak-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .fire-icon { transition: transform 0.2s; }
        .streak-animate { transform: scale(1.5); color: #ff9800; }

        /* --- 4. TABLERO --- */
        #board {
            width: 95vw;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            background-color: var(--primary-dark); /* Color de las l√≠neas */
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            border: 3px solid var(--primary-dark);
            border-radius: 8px; /* Bordes suaves externos */
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(156, 179, 201, 0.4); /* Sombra con tu color */
            gap: 1px; /* Espacio para las l√≠neas finas */
        }

        .tile {
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            position: relative; /* Para las notas */
            transition: background-color 0.1s;
        }

        /* L√≠neas gruesas internas usando m√°rgenes o bordes */
        .tile:nth-child(3n) { border-right: 2px solid var(--primary-dark); }
        .tile:nth-child(9n) { border-right: none; } /* Correcci√≥n borde final */
        
        /* L√≠neas horizontales gruesas */
        .horizontal-line { border-bottom: 2px solid var(--primary-dark); }

        /* Estados de las casillas */
        .tile-start { 
            background-color: #fcfcfc; 
            color: #263238; 
            font-weight: 700; 
        }
        
        .tile-selected {
            background-color: var(--primary) !important;
            color: white !important;
        }

        .highlight-related { background-color: #eceff1; } /* Gris muy tenue */
        .highlight-same { 
            background-color: var(--primary); 
            opacity: 0.7; 
            color: white; 
        }

        .tile-correct { color: var(--primary-dark); } /* Azul elegante */
        .tile-incorrect { 
            background-color: var(--error-color); 
            color: white;
            animation: shake 0.3s; 
        }

        /* --- 5. CONTROLES Y TECLADO --- */
        #controls-container {
            width: 95vw;
            max-width: 400px;
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Herramientas circulares */
        #tools-row {
            display: flex;
            justify-content: space-evenly;
        }

        .tool-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background-color: white;
            color: var(--primary-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .tool-btn:active { transform: scale(0.95); }

        /* Estados activos de herramientas */
        .pencil-active { 
            background-color: var(--primary) !important; 
            color: white !important; 
            box-shadow: 0 0 10px var(--primary);
        }
        
        .fast-active { 
            background-color: #7e57c2 !important; /* Violeta suave */
            color: white !important; 
            box-shadow: 0 0 10px #7e57c2;
        }

        /* Teclado num√©rico */
        #numbers-row {
            display: flex;
            justify-content: space-between;
        }

        .number-key {
            width: 10%;
            aspect-ratio: 1/1.3;
            border: none;
            border-radius: 8px;
            background-color: white;
            color: var(--primary-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .number-key:active { background-color: #eceff1; }
        
        .number-selected {
            background-color: var(--primary) !important;
            color: white !important;
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(156, 179, 201, 0.5);
        }

        .number-done {
            opacity: 0.2;
            pointer-events: none;
            box-shadow: none;
            background: #e0e0e0;
        }

        /* --- NOTAS (L√ÅPIZ) --- */
        .pencil-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%;
            pointer-events: none;
        }
        .pencil-number {
            display: flex; justify-content: center; align-items: center;
            font-size: 10px; color: var(--primary-dark);
        }

        /* Animaci√≥n de error */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

    </style>
</head>
<body>

    <h1>Sudoku</h1>

    <div id="difficulty-controls">
        <button id="btn-easy" class="diff-btn" onclick="startGame('easy')">F√°cil</button>
        <button id="btn-medium" class="diff-btn" onclick="startGame('medium')">Medio</button>
        <button id="btn-hard" class="diff-btn" onclick="startGame('hard')">Dif√≠cil</button>
    </div>

    <div id="stats-bar">
        <div class="streak-container">
            <span id="fire-icon" class="fire-icon">üî•</span> 
            <span id="streak-display">Racha: 0</span>
        </div>
        <span style="color: var(--primary); font-size: 0.9em;">Pistas: <span id="hints-display">0</span></span>
    </div>

    <div id="board"></div>
    
    <div id="controls-container">
        
        <div id="tools-row">
            <div id="pencil-btn" class="tool-btn" onclick="togglePencil()" title="Modo Notas (L√°piz)">‚úé</div>
            <div id="fast-btn" class="tool-btn" onclick="toggleFastMode()" title="Relleno R√°pido">‚ö°</div>
            <div class="tool-btn" onclick="useHint()" title="Pista" style="color: #fbc02d;">üí°</div>
            <div class="tool-btn" onclick="deleteAction()" title="Borrar">üßπ</div>
        </div>

        <div id="numbers-row">
            <div id="num-1" class="number-key" onclick="onNumberClick('1')">1</div>
            <div id="num-2" class="number-key" onclick="onNumberClick('2')">2</div>
            <div id="num-3" class="number-key" onclick="onNumberClick('3')">3</div>
            <div id="num-4" class="number-key" onclick="onNumberClick('4')">4</div>
            <div id="num-5" class="number-key" onclick="onNumberClick('5')">5</div>
            <div id="num-6" class="number-key" onclick="onNumberClick('6')">6</div>
            <div id="num-7" class="number-key" onclick="onNumberClick('7')">7</div>
            <div id="num-8" class="number-key" onclick="onNumberClick('8')">8</div>
            <div id="num-9" class="number-key" onclick="onNumberClick('9')">9</div>
        </div>
    </div>

    <script>
   // --- VARIABLES GLOBALES ---
    let numSelected = null;
    let tileSelected = null;
    let streak = 0; 
    let hintsUsed = 0;
    let currentSolution = "";
    
    let isPencilMode = false;
    let isFastMode = false;
    let currentDifficulty = 'easy';

    // --- BASE DE DATOS VERIFICADA Y LIMPIA ---
    // He reducido la cantidad para asegurar calidad. 
    // La permutaci√≥n se encargar√° de que parezcan miles de juegos distintos.
    const database = {
        easy: [
            { 
                p: "53--7----6--195----98----6-8---6---34--8-3--17---2---6-6----28----419--5----8--79", 
                s: "534678912672195348198342567859761423426853791713924856961537284287419635345286179" 
            },
            {
                p: "-5-1-4----1-5---89---83--2------1-5--3-----1--6-2------4--63---28---7-4----9-1-3-",
                s: "852174369617529483394836521478691253532478916961253748745163892283917645126985437"
            }
        ],
        medium: [
            { 
                p: "2---8-3---6--7--84-3-5--2-9---1-54-8---------4-27-6---3-1--7-4-72--4--6---4-1---3", 
                s: "247981356965273184831564279679135428813429765542786913351697842728345691194812537" 
            },
            {
                p: "--2---3--84-3---9-91-----4----2-8-37-3-----2-52-4-9----7-----63-9---4-54--3---7--", 
                s: "652794318847312695913586247169258437734169528528479163471825963296347851385691742" 
            }
        ],
        hard: [
            { 
                p: "---9---5-3-------8--82--7--1-----4-2-7--1--9-2-6-----7--1--72--7-------4-2---8---", 
                s: "462971853357462918918253746185739462674815391239641587841527639793186245526394178" 
            },
            {
                p: "-6---9--2---1-6-4--8------16------2-3---8---4-9------81------6--5-6-3---2--1---9-",
                s: "467539812529186743381247659614758923372981564895623174136492587248765391953814265"
            }
        ]
    };

    window.onload = function() {
        startGame('easy');
    }

    // --- MOTOR DEL JUEGO ---
    function startGame(difficulty) {
        currentDifficulty = difficulty;
        
        // Actualizar UI
        document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
        let btnDiff = document.getElementById('btn-' + difficulty);
        if(btnDiff) btnDiff.classList.add('active');

        // Resetear Estados
        streak = 0;
        hintsUsed = 0;
        updateStats();
        
        clearSelections();
        isPencilMode = false;
        isFastMode = false;
        updateToolVisuals();
        
        document.getElementById("board").innerHTML = ""; 

        // --- GENERACI√ìN DEL JUEGO ---
        let gamesList = database[difficulty];
        let randomIndex = Math.floor(Math.random() * gamesList.length);
        let baseGame = gamesList[randomIndex];
        
        // Permutaci√≥n de n√∫meros (Mezcla)
        let newGameData = getPermutedGame(baseGame.p, baseGame.s);

        let currentBoardString = newGameData.puzzle;
        currentSolution = newGameData.solution;

        // TRAMPA DE DEBUG: Abre la consola (F12) para ver la soluci√≥n real si tienes dudas
        console.log("--- NUEVO JUEGO GENERADO ---");
        console.log("Soluci√≥n correcta:", currentSolution);

        // Construir Tablero
        for (let i = 0; i < 81; i++) {
            let tile = document.createElement("div");
            tile.id = i.toString();
            
            // Aseguramos que solo tomamos caracteres v√°lidos
            let char = currentBoardString.charAt(i);
            
            if (char !== "-") {
                tile.innerText = char;
                tile.classList.add("tile-start"); 
            }

            // Estilos de bordes 3x3
            let col = i % 9;
            let row = Math.floor(i / 9);
            if (col === 2 || col === 5) tile.style.borderRight = "2px solid var(--primary-dark)";
            if (row === 2 || row === 5) tile.style.borderBottom = "2px solid var(--primary-dark)";

            tile.addEventListener("click", onTileClick);
            tile.classList.add("tile");
            document.getElementById("board").append(tile);
        }

        checkCompletedNumbers();
    }

    // --- FUNCI√ìN DE PERMUTACI√ìN M√ÅS SEGURA ---
    function getPermutedGame(puzzle, solution) {
        // 1. Array base del 1 al 9
        let nums = ['1','2','3','4','5','6','7','8','9'];
        
        // 2. Mezclar aleatoriamente (Shuffle)
        for (let i = nums.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [nums[i], nums[j]] = [nums[j], nums[i]];
        }
        
        // 3. Mapear las cadenas originales con los nuevos n√∫meros
        function mapString(str) {
            let result = "";
            for(let i=0; i<str.length; i++) {
                let char = str.charAt(i);
                
                // Si es un n√∫mero del 1 al 9
                if (char >= '1' && char <= '9') {
                    let index = parseInt(char) - 1;
                    result += nums[index];
                } else {
                    // Cualquier otra cosa (espacio, guion, punto) es vac√≠o
                    result += "-";
                }
            }
            return result;
        }

        return {
            puzzle: mapString(puzzle),
            solution: mapString(solution)
        };
    }

    // --- HERRAMIENTAS ---
    function togglePencil() {
        isPencilMode = !isPencilMode;
        updateToolVisuals();
    }

    function toggleFastMode() {
        isFastMode = !isFastMode;
        clearSelections();
        updateToolVisuals();
    }
    
    function updateToolVisuals() {
        let pBtn = document.getElementById("pencil-btn");
        let fBtn = document.getElementById("fast-btn");
        
        if (pBtn) isPencilMode ? pBtn.classList.add("pencil-active") : pBtn.classList.remove("pencil-active");
        if (fBtn) isFastMode ? fBtn.classList.add("fast-active") : fBtn.classList.remove("fast-active");
        
        if (!isFastMode) {
            numSelected = null;
            document.querySelectorAll(".number-key").forEach(n => n.classList.remove("number-selected"));
        }
    }

    function useHint() {
        if (isFastMode) { alert("Desactiva el modo r√°pido para usar pistas."); return; }
        if (!tileSelected) { alert("Selecciona una casilla vac√≠a."); return; }
        if (tileSelected.classList.contains("tile-start") || tileSelected.classList.contains("tile-correct")) return;

        let position = parseInt(tileSelected.id);
        let correctNum = currentSolution.charAt(position);

        tileSelected.innerText = correctNum;
        
        // Limpiar l√°piz si hab√≠a notas
        let grid = tileSelected.querySelector(".pencil-grid");
        if(grid) grid.remove();

        tileSelected.classList.remove("tile-incorrect");
        tileSelected.classList.add("tile-correct");
        
        hintsUsed++;
        updateStats();
        updateHighlights();
        checkCompletedNumbers();
    }

    function deleteAction() {
        if (tileSelected && !tileSelected.classList.contains("tile-start") && !tileSelected.classList.contains("tile-correct")) {
            tileSelected.innerText = ""; // Usar innerText limpia tambi√©n el grid de l√°piz
            tileSelected.classList.remove("tile-incorrect");
            updateHighlights();
        }
    }

    // --- INTERACCI√ìN ---
    function onTileClick() {
        let clickedTile = this;
        if (isFastMode) {
            if (numSelected) applyMove(clickedTile, numSelected);
            return;
        }
        if (tileSelected) tileSelected.classList.remove("tile-selected");
        tileSelected = clickedTile;
        tileSelected.classList.add("tile-selected");
        updateHighlights();
    }

    function onNumberClick(numberClicked) {
        let btn = document.getElementById("num-" + numberClicked);
        if (btn && btn.classList.contains("number-done")) return;

        if (isFastMode) {
            numSelected = numberClicked;
            document.querySelectorAll(".number-key").forEach(n => n.classList.remove("number-selected"));
            if(btn) btn.classList.add("number-selected");
            highlightSameNumbers(numberClicked);
            return;
        }
        
        if (tileSelected) {
            applyMove(tileSelected, numberClicked);
        }
    }

    // --- L√ìGICA DE VALIDACI√ìN ---
    function applyMove(tile, number) {
        // 1. Protecciones
        if (tile.classList.contains("tile-start") || tile.classList.contains("tile-correct")) return;

        // 2. Modo L√°piz
        if (isPencilMode) {
            if (tile.innerText.length === 1 && !tile.querySelector(".pencil-grid")) return;
            
            let grid = tile.querySelector(".pencil-grid");
            if (!grid) {
                tile.innerText = "";
                grid = document.createElement("div");
                grid.classList.add("pencil-grid");
                for(let i=1; i<=9; i++) {
                    let note = document.createElement("div");
                    note.classList.add("pencil-number");
                    grid.appendChild(note);
                }
                tile.appendChild(grid);
            }
            // number viene como string '1', restamos 1 para index 0
            let notePlace = grid.children[parseInt(number) - 1];
            notePlace.innerText = (notePlace.innerText === number) ? "" : number;
            return;
        }

        // 3. NUEVO: Verificar CONFLICTO VISUAL antes de chequear soluci√≥n
        // Si el usuario pone un 6, y ya hay un 6 en la fila, le avisamos antes de ponerlo rojo por error.
        let conflict = checkVisualConflict(parseInt(tile.id), number);
        if (conflict) {
            // Hacemos vibrar la casilla conflictiva
            let conflictTile = document.getElementById(conflict.id);
            conflictTile.classList.add("tile-incorrect"); 
            setTimeout(() => conflictTile.classList.remove("tile-incorrect"), 400);
            
            // Tambi√©n vibramos la casilla actual
            tile.classList.add("tile-incorrect");
            setTimeout(() => tile.classList.remove("tile-incorrect"), 400);
            return; // No ponemos el n√∫mero
        }

        // 4. Validar Soluci√≥n
        tile.innerText = number;
        // Si hab√≠a notas (l√°piz), se borran autom√°ticamente al hacer innerText
        
        let position = parseInt(tile.id);
        let correctNumber = currentSolution.charAt(position);

        if (number === correctNumber) {
            // ACIERTO
            tile.classList.remove("tile-incorrect");
            tile.classList.add("tile-correct");
            
            streak++; 
            animateStreak();

            if (!isFastMode) updateHighlights();
            else highlightSameNumbers(numSelected);
            checkCompletedNumbers();
        } else {
            // ERROR (No hay conflicto visual, pero no es la soluci√≥n de este puzzle espec√≠fico)
            tile.classList.add("tile-incorrect");
            tile.classList.remove("tile-correct");
            
            streak = 0;
            updateStats();
        }
    }
    
    // --- FUNCI√ìN PARA DETECTAR SI EL N√öMERO YA EXISTE EN FILA/COL/CUADRO ---
    function checkVisualConflict(currentId, number) {
        let currentRow = Math.floor(currentId / 9);
        let currentCol = currentId % 9;
        let startRow = Math.floor(currentRow / 3) * 3;
        let startCol = Math.floor(currentCol / 3) * 3;

        for (let i = 0; i < 81; i++) {
            if (i === currentId) continue; // No chequear contra s√≠ mismo

            let tile = document.getElementById(i.toString());
            // Ignorar casillas vac√≠as o con notas de l√°piz
            if (tile.innerText === "" || tile.querySelector(".pencil-grid")) continue;

            if (tile.innerText === number) {
                let r = Math.floor(i / 9);
                let c = i % 9;

                // Es Fila? O Columna? O Cuadro 3x3?
                if (r === currentRow || c === currentCol || 
                   (r >= startRow && r < startRow + 3 && c >= startCol && c < startCol + 3)) {
                    return tile; // Retornamos la casilla culpable
                }
            }
        }
        return null; // No hay conflicto visual
    }

    // --- HELPERS ---
    function checkCompletedNumbers() {
        let counts = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0};
        let allTiles = document.querySelectorAll(".tile");
        allTiles.forEach(tile => {
            if (!tile.querySelector(".pencil-grid") && tile.innerText !== "") {
                if (tile.classList.contains("tile-start") || tile.classList.contains("tile-correct")) {
                    let num = parseInt(tile.innerText);
                    if (num >= 1 && num <= 9) counts[num]++;
                }
            }
        });

        for (let i = 1; i <= 9; i++) {
            let btn = document.getElementById("num-" + i);
            if (btn) {
                if (counts[i] === 9) {
                    btn.classList.add("number-done");
                    if (isFastMode && numSelected == i) {
                        btn.classList.remove("number-selected");
                        numSelected = null;
                        document.querySelectorAll(".highlight-same").forEach(el => el.classList.remove("highlight-same"));
                    }
                } else {
                    btn.classList.remove("number-done");
                }
            }
        }
    }

    function updateStats() {
        let streakEl = document.getElementById("streak-display");
        if(streakEl) streakEl.innerText = "Racha: " + streak;
        
        let hintsEl = document.getElementById("hints-display");
        if(hintsEl) hintsEl.innerText = hintsUsed;
        
        let fire = document.getElementById("fire-icon");
        if(fire) fire.style.opacity = (streak > 0) ? "1" : "0.2";
    }
    
    function animateStreak() {
        updateStats();
        let fire = document.getElementById("fire-icon");
        if(fire) {
            fire.classList.add("streak-animate");
            setTimeout(() => fire.classList.remove("streak-animate"), 200);
        }
    }

    function clearSelections() {
        if (tileSelected) tileSelected.classList.remove("tile-selected");
        tileSelected = null;
        document.querySelectorAll(".tile").forEach(t => {
            t.classList.remove("highlight-related");
            t.classList.remove("highlight-same");
        });
    }

    function updateHighlights() {
        document.querySelectorAll(".tile").forEach(t => {
            t.classList.remove("highlight-related");
            t.classList.remove("highlight-same");
        });

        if (!tileSelected) return;

        let currentId = parseInt(tileSelected.id);
        let currentRow = Math.floor(currentId / 9);
        let currentCol = currentId % 9;
        let val = (!tileSelected.querySelector(".pencil-grid")) ? tileSelected.innerText : null;

        for (let i = 0; i < 81; i++) {
            let row = Math.floor(i / 9);
            let col = i % 9;
            let tile = document.getElementById(i.toString());
            
            if (row === currentRow || col === currentCol) {
                if (i !== currentId) tile.classList.add("highlight-related");
            }
            if (val && tile.innerText === val && !tile.querySelector(".pencil-grid")) {
                tile.classList.add("highlight-same");
            }
        }
    }

    function highlightSameNumbers(number) {
        document.querySelectorAll(".tile").forEach(t => t.classList.remove("highlight-same"));
        document.querySelectorAll(".tile").forEach(tile => {
            if (tile.innerText === number && !tile.querySelector(".pencil-grid")) {
                tile.classList.add("highlight-same");
            }
        });
    }
    </script>
</body>

</html>

